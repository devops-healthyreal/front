name: CI/CD Pipeline - Vue Frontend

# Trigger on push to dev or main branch
on:
  push:
    branches:
      - dev
      - release
  workflow_dispatch:  # Allow manual trigger

# Permissions for GITHUB_TOKEN
permissions:
  contents: write
  pull-requests: write

# Environment variables
env:
  JENKINS_WEBHOOK_URL: ${{ secrets.JENKINS_WEBHOOK_URL }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # Auto create PR from dev to main
  auto-pr-dev-to-main:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get commit information
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request from dev to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: dev
          base: release
          title: "ðŸš€ [Auto PR] Deploy dev to release"
          body: |
            ## ðŸ“¦ ìžë™ ìƒì„±ëœ ë°°í¬ PR
            
            **Dev ë¸Œëžœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ Mainìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.**
            
            ### ðŸ“ ìµœê·¼ ì»¤ë°‹ ì •ë³´
            - **Author**: ${{ steps.commit_info.outputs.commit_author }}
            - **Message**: ${{ steps.commit_info.outputs.commit_message }}
            - **Branch**: dev â†’ main
            
            ### âœ… ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
            - [ ] í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
            - [ ] ë°°í¬ ì¤€ë¹„ ì™„ë£Œ
            
            ### ðŸ”„ ë°°í¬ í”„ë¡œì„¸ìŠ¤
            ì´ PRì´ mergeë˜ë©´ Jenkinsë¥¼ í†µí•´ ìžë™ìœ¼ë¡œ ìš´ì˜ ì„œë²„ì— ë°°í¬ë©ë‹ˆë‹¤.
            
            ---
            *ì´ PRì€ dev ë¸Œëžœì¹˜ push ì‹œ ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          labels: |
            auto-pr
            deployment
          draft: false
      
      - name: PR Creation Summary
        run: |
          echo "## ðŸŽ¯ PR ìžë™ ìƒì„± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: dev â†’ main" >> $GITHUB_STEP_SUMMARY
          echo "**Author**: ${{ steps.commit_info.outputs.commit_author }}" >> $GITHUB_STEP_SUMMARY
          echo "**Message**: ${{ steps.commit_info.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
          echo "1. PR ë¦¬ë·° ë° ìŠ¹ì¸" >> $GITHUB_STEP_SUMMARY
          echo "2. Main ë¸Œëžœì¹˜ë¡œ merge" >> $GITHUB_STEP_SUMMARY
          echo "3. Jenkins ìžë™ ë°°í¬ ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
  
  # Notify Jenkins on main branch push
  notify-jenkins:
    if: github.ref == 'refs/heads/release'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get commit information
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
      
      - name: Notify Jenkins for deployment
        uses: actions/github-script@v7
        with:
          script: |
            const payload = {
              ref: 'main',
              commits: [{
                id: '${{ steps.commit_info.outputs.commit_sha }}',
                message: `${{ steps.commit_info.outputs.commit_message }}`,
                author: {
                  name: '${{ steps.commit_info.outputs.commit_author }}'
                },
                timestamp: new Date().toISOString()
              }],
              repository: {
                name: context.repo.repo,
                full_name: context.repo.owner + '/' + context.repo.repo
              }
            };
            
            console.log('ðŸš€ Vue Frontend deployment triggered');
            console.log('ðŸ“¦ Commit:', payload.commits[0].id.substring(0, 7));
            console.log('ðŸ‘¤ Author:', payload.commits[0].author.name);
            console.log('ðŸ“ Message:', payload.commits[0].message);
            
            // Jenkins webhook URL - íŒ€ ì„œë²„ Jenkins
            const jenkinsUrl = process.env.JENKINS_WEBHOOK_URL;
            
            try {
              const response = await fetch(jenkinsUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-GitHub-Event': 'push'
                },
                body: JSON.stringify(payload)
              });
              
              if (response.ok) {
                console.log('âœ… Jenkins notification sent successfully');
              } else {
                console.log('âš ï¸ Jenkins notification failed:', response.status, response.statusText);
              }
            } catch (error) {
              console.log('âŒ Failed to notify Jenkins:', error.message);
              console.log('ðŸ“‹ Manual deployment info:');
              console.log('- Repository:', context.repo.owner + '/' + context.repo.repo);
              console.log('- Branch: main');
              console.log('- Commit:', payload.commits[0].id);
            }
      
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Vue Frontend Deployment Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ steps.commit_info.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author**: ${{ steps.commit_info.outputs.commit_author }}" >> $GITHUB_STEP_SUMMARY
          echo "**Message**: ${{ steps.commit_info.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Jenkins will build Docker image" >> $GITHUB_STEP_SUMMARY
          echo "2. Push to DockerHub" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy to production server" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: íŒ€ ì„œë²„ (Production)" >> $GITHUB_STEP_SUMMARY
          echo "**Service**: Vue Frontend (Port 7001)" >> $GITHUB_STEP_SUMMARY

