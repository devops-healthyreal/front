pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        timestamps()
    }

    parameters {
        string(name: 'IMAGE_NAME', defaultValue: 'healthyreal-vue', description: 'ì´ë¯¸ì§€ ì´ë¦„')
        string(name: 'K8S_NAMESPACE', defaultValue: 'healthyreal', description: 'ë°°í¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤')
        string(name: 'K8S_CONTEXT', defaultValue: 'your-kube-context', description: 'kubectl context')
        string(name: 'SONAR_PROJECT_KEY', defaultValue: 'healthyreal-front', description: 'SonarQube project key')
        string(name: 'SONAR_HOST_URL', defaultValue: 'http://3.39.158.19:9000', description: 'SonarQube Server URL')  // ì¶”ê°€
        string(name: 'K3S_NODE_IP', defaultValue: '', description: 'k3s ì„¤ì¹˜ì¹˜ IP (Prometheus ìŠ¤í¬ë©ìš©)')
    }

    environment {
        IMAGE_TAG = "${env.GIT_COMMIT?.take(7) ?: 'dev'}"
        DOCKERHUB_CREDENTIALS = 'dockerhub-credentials'
        KUBECONFIG_CREDENTIALS = 'kubeconfig-credentials-id'
        GITHUB_CREDENTIALS     = 'jimin-github'
        SONARQUBE_SERVER       = 'SonarScanner'
        SONARQUBE_CREDENTIALS  = 'sonarqube-token'  // Jenkinsì— Secret text credentialsë¡œ ìƒì„± í•„ìš”
        K8S_DIR = 'k8s'
        KUBECTL_BIN = 'k3s kubectl'
        GITHUB_REPO = 'devops-healthyreal/front'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh '''
                  echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
                  echo "Commit: $(git rev-parse --short HEAD)"
                  echo "Commit message: $(git log -1 --pretty=%B)"
                '''
            }
        }

        stage('SonarQube (release)') {
            when { 
                anyOf {
                    expression { env.BRANCH_NAME == 'release' || env.BRANCH_NAME == 'origin/release' }
                    expression { env.GIT_BRANCH?.endsWith('/release') }
                }
            }
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    
                    withSonarQubeEnv(installationName: "${SONARQUBE_SERVER}") {
                        withCredentials([
                            string(credentialsId: "${SONARQUBE_CREDENTIALS}", variable: 'SONAR_TOKEN')
                        ]) {
                            sh """
                              echo "[INFO] Starting SonarQube scan..."
                              echo "[INFO] SonarQube Server: ${params.SONAR_HOST_URL}"
                              echo "[INFO] Using sonar-project.properties file"
                              
                              # sonar-project.properties íŒŒì¼ì„ ì‚¬ìš©í•˜ë„ë¡ ëª…ë ¹ì–´ ê°„ì†Œí™”
                              # ì»¨í…Œì´ë„ˆëŠ” í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ sonar-project.properties íŒŒì¼ì„ ìë™ìœ¼ë¡œ ì½ìŠµë‹ˆë‹¤.
                              docker run --rm \\
                                -v \$(pwd):/usr/src \\
                                -w /usr/src \\
                                -e SONAR_HOST_URL=${params.SONAR_HOST_URL} \\
                                -e SONAR_TOKEN=\${SONAR_TOKEN} \\
                                sonarsource/sonar-scanner-cli:latest
                            """
                        }
                    }
                }
            }
        }

        stage('SonarQube Quality Gate (release)') {
            when { 
                anyOf {
                    expression { env.BRANCH_NAME == 'release' || env.BRANCH_NAME == 'origin/release' }
                    expression { env.GIT_BRANCH?.endsWith('/release') }
                }
            }
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Create PR to develop (release)') {
            when { 
                anyOf {
                    expression { env.BRANCH_NAME == 'release' || env.BRANCH_NAME == 'origin/release' }
                    expression { env.GIT_BRANCH?.endsWith('/release') }
                }
            }
            steps {
                script {
                    def sonarUrl = sh(
                        script: '''
                          echo "${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}" || echo ""
                        ''',
                        returnStdout: true
                    ).trim()
                    
                    def commitMsg = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()
                    
                    def commitAuthor = sh(
                        script: 'git log -1 --pretty=%an',
                        returnStdout: true
                    ).trim()
                    
                    def commitSha = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    
                    def prBody = """
## ğŸ“¦ ìë™ ìƒì„±ëœ ë°°í¬ PR

**Release ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ Developìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.**

### ğŸ“ ìµœê·¼ ì»¤ë°‹ ì •ë³´
- **Author**: ${commitAuthor}
- **Message**: ${commitMsg}
- **Commit**: ${commitSha}
- **Branch**: release â†’ develop

### âœ… SonarQube í’ˆì§ˆ ê²€ì‚¬
- **Status**: âœ… Quality Gate í†µê³¼
${sonarUrl ? "- **Report**: ${sonarUrl}" : ""}

### âœ… ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] SonarQube Quality Gate í†µê³¼
- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
- [ ] í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
- [ ] ë°°í¬ ì¤€ë¹„ ì™„ë£Œ

### ğŸ”„ ë°°í¬ í”„ë¡œì„¸ìŠ¤
ì´ PRì´ mergeë˜ë©´ Jenkinsë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ìš´ì˜ ì„œë²„(k3s)ì— ë°°í¬ë©ë‹ˆë‹¤.

---
*ì´ PRì€ SonarQube Quality Gate í†µê³¼ í›„ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
"""
                    
                    withCredentials([string(credentialsId: "${GITHUB_CREDENTIALS}", variable: 'GITHUB_TOKEN')]) {
                        sh """
                          if command -v gh >/dev/null 2>&1; then
                            export GH_TOKEN="${GITHUB_TOKEN}"
                            gh pr create \\
                              --base develop \\
                              --head release \\
                              --title "ğŸš€ [Auto PR] Deploy release to develop - ${commitSha}" \\
                              --body "${prBody}" \\
                              --label "auto-pr,deployment" || echo "PR may already exist"
                          else
                            curl -X POST \\
                              -H "Authorization: token ${GITHUB_TOKEN}" \\
                              -H "Accept: application/vnd.github.v3+json" \\
                              https://api.github.com/repos/${GITHUB_REPO}/pulls \\
                              -d '{
                                "title": "ğŸš€ [Auto PR] Deploy release to develop - ${commitSha}",
                                "head": "release",
                                "base": "develop",
                                "body": ${groovy.json.JsonOutput.toJson(prBody)},
                                "labels": ["auto-pr", "deployment"]
                              }' || echo "PR creation failed or already exists"
                          fi
                        """
                    }
                }
            }
        }

        stage('Build & Push Image (develop)') {
            when { branch 'develop' }
            steps {
                withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CREDENTIALS}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                      echo "Building ${DOCKERHUB_CREDENTIALS_USR}/${IMAGE_NAME}:${IMAGE_TAG}"
                      docker build -t ${DOCKERHUB_CREDENTIALS_USR}/${IMAGE_NAME}:${IMAGE_TAG} -f Dockerfile .
                      echo "${DOCKERHUB_CREDENTIALS_PSW}" | docker login -u "${DOCKERHUB_CREDENTIALS_USR}" --password-stdin
                      docker push ${DOCKERHUB_CREDENTIALS_USR}/${IMAGE_NAME}:${IMAGE_TAG}
                    '''
                }
            }
        }

        stage('Deploy to Kubernetes (develop)') {
            when { branch 'develop' }
            steps {
                withCredentials([string(credentialsId: "${KUBECONFIG_CREDENTIALS}", variable: 'KUBECONFIG_CONTENT'), credentials('dockerhub-credentials')]) {
                    sh '''
                      # Secret textì˜ ë‚´ìš©ì„ ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
                      echo "${KUBECONFIG_CONTENT}" > /tmp/kubeconfig-${BUILD_NUMBER}
                      chmod 600 /tmp/kubeconfig-${BUILD_NUMBER}
                      export KUBECONFIG="/tmp/kubeconfig-${BUILD_NUMBER}"
                      
                      ${KUBECTL_BIN} config use-context ${K8S_CONTEXT}
                      
                      # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±)
                      if ! ${KUBECTL_BIN} get ns ${K8S_NAMESPACE} >/dev/null 2>&1; then
                        echo "Creating namespace: ${K8S_NAMESPACE}"
                        ${KUBECTL_BIN} create ns ${K8S_NAMESPACE}
                      else
                        echo "Namespace ${K8S_NAMESPACE} already exists"
                      fi

                      # 1. Metrics Service ë°°í¬ (nginx-exporterë¥¼ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
                      ${KUBECTL_BIN} apply -f ${K8S_DIR}/service-metrics-nodeport.yaml

                      # 2. Vue ì•± Deployment ë°°í¬ (ì´ë¯¸ì§€ íƒœê·¸ë¥¼ êµì²´í•œ í›„ ì ìš©)
                      ${KUBECTL_BIN} -n ${K8S_NAMESPACE} apply -f ${K8S_DIR}/deployment.yaml
                      ${KUBECTL_BIN} -n ${K8S_NAMESPACE} set image deployment/front front=${DOCKERHUB_CREDENTIALS_USR}/${IMAGE_NAME}:${IMAGE_TAG}
                      ${KUBECTL_BIN} -n ${K8S_NAMESPACE} rollout status deployment/front --timeout=180s

                      # ë©”íŠ¸ë¦­/í—¬ìŠ¤ ê°„ë‹¨ í™•ì¸
                      if [ -n "${K3S_NODE_IP}" ]; then
                        echo "[Info] Metrics endpoint: http://${K3S_NODE_IP}:9000/metrics"
                        echo "[Info] Test: curl http://${K3S_NODE_IP}:9000/metrics | head -n 5 || true"
                      else
                        echo "[Info] K3S_NODE_IP íŒŒë¼ë¯¸í„°ë¥¼ ì„¤ì •í•˜ë©´ metrics endpoint ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤."
                        echo "[Info] Metrics endpoint: http://<K3S_NODE_IP>:9000/metrics"
                      fi
                      
                      # ì„ì‹œ íŒŒì¼ ì •ë¦¬ (ì„ íƒì‚¬í•­)
                      rm -f /tmp/kubeconfig-${BUILD_NUMBER}
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "OK: ${env.BRANCH_NAME} -> ${params.IMAGE_NAME}:${env.IMAGE_TAG}"
        }
        failure {
            echo "Pipeline failed."
        }
    }
}