pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        timestamps()
    }

    parameters {
        string(name: 'IMAGE_NAME', defaultValue: 'healthyreal-vue', description: 'ì´ë¯¸ì§€ ì´ë¦„')
        string(name: 'K8S_NAMESPACE', defaultValue: 'healthyreal', description: 'ë°°í¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤')
        string(name: 'K8S_CONTEXT', defaultValue: 'your-kube-context', description: 'kubectl context')
        string(name: 'SONAR_PROJECT_KEY', defaultValue: 'healthyreal-front', description: 'SonarQube project key')
        string(name: 'K3S_NODE_IP', defaultValue: '', description: 'k3s ë…¸ë“œì˜ ê³µì¸ IP (Prometheus ìŠ¤í¬ë©ìš©)')
    }

    environment {
        IMAGE_TAG = "${env.GIT_COMMIT?.take(7) ?: 'dev'}"
        DOCKERHUB_CREDENTIALS = 'dockerhub-credentials'
        KUBECONFIG_CREDENTIALS = 'kubeconfig-credentials-id'
        GITHUB_CREDENTIALS     = 'jimin-github'  // GitHub Personal Access Token
        SONARQUBE_SERVER       = 'SonarScanner'  // Jenkins ì„¤ì •ê³¼ ì¼ì¹˜
        K8S_DIR = 'k8s'
        KUBECTL_BIN = 'k3s kubectl'
        GITHUB_REPO = "${env.GIT_URL?.replaceAll('https://github.com/', '')?.replaceAll('\\.git$', '') ?: 'OWNER/REPO'}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh '''
                  echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
                  echo "Commit: $(git rev-parse --short HEAD)"
                  echo "Commit message: $(git log -1 --pretty=%B)"
                '''
            }
        }

        stage('Node Build') {
            when { anyOf { branch 'develop'; branch 'main' } }
            steps {
                dir('front') {
                    sh '''
                      corepack enable || true
                      if command -v pnpm >/dev/null 2>&1; then
                        pnpm install --frozen-lockfile || pnpm install
                        pnpm build
                      elif command -v yarn >/dev/null 2>&1; then
                        yarn install --frozen-lockfile || yarn install
                        yarn build
                      else
                        npm ci || npm install
                        npm run build
                      fi
                    '''
                }
            }
        }

        stage('SonarQube (develop)') {
            when { branch 'develop' }
            steps {
                withSonarQubeEnv("${SONARQUBE_SERVER}") {
                    dir('front') {
                        sh '''
                          npx --yes sonar-scanner \
                            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                            -Dsonar.sources=src \
                            -Dsonar.sourceEncoding=UTF-8
                        '''
                    }
                }
            }
        }

        stage('SonarQube Quality Gate (develop)') {
            when { branch 'develop' }
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Create PR to main (develop)') {
            when { branch 'develop' }
            steps {
                script {
                    def sonarUrl = sh(
                        script: '''
                          # SonarQube ë¦¬í¬íŠ¸ URL ì¶”ì¶œ (í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ SonarQube ì„œë²„ URL ì¡°í•©)
                          echo "${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}" || echo ""
                        ''',
                        returnStdout: true
                    ).trim()
                    
                    def commitMsg = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()
                    
                    def commitAuthor = sh(
                        script: 'git log -1 --pretty=%an',
                        returnStdout: true
                    ).trim()
                    
                    def commitSha = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    
                    def prBody = """
## ğŸ“¦ ìë™ ìƒì„±ëœ ë°°í¬ PR

**Develop ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ Mainìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.**

### ğŸ“ ìµœê·¼ ì»¤ë°‹ ì •ë³´
- **Author**: ${commitAuthor}
- **Message**: ${commitMsg}
- **Commit**: ${commitSha}
- **Branch**: develop â†’ main

### âœ… SonarQube í’ˆì§ˆ ê²€ì‚¬
- **Status**: âœ… Quality Gate í†µê³¼
${sonarUrl ? "- **Report**: ${sonarUrl}" : ""}

### âœ… ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] SonarQube Quality Gate í†µê³¼
- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
- [ ] í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
- [ ] ë°°í¬ ì¤€ë¹„ ì™„ë£Œ

### ğŸ”„ ë°°í¬ í”„ë¡œì„¸ìŠ¤
ì´ PRì´ mergeë˜ë©´ Jenkinsë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ìš´ì˜ ì„œë²„(k3s)ì— ë°°í¬ë©ë‹ˆë‹¤.

---
*ì´ PRì€ SonarQube Quality Gate í†µê³¼ í›„ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
"""
                    
                    withCredentials([string(credentialsId: "${GITHUB_CREDENTIALS}", variable: 'GITHUB_TOKEN')]) {
                        sh """
                          # GitHub CLI ë˜ëŠ” curlì„ ì‚¬ìš©í•˜ì—¬ PR ìƒì„±
                          if command -v gh >/dev/null 2>&1; then
                            # GitHub CLI ì‚¬ìš©
                            export GH_TOKEN="${GITHUB_TOKEN}"
                            gh pr create \\
                              --base main \\
                              --head develop \\
                              --title "ğŸš€ [Auto PR] Deploy develop to main - ${commitSha}" \\
                              --body "${prBody}" \\
                              --label "auto-pr,deployment" || echo "PR may already exist"
                          else
                            # GitHub API ì§ì ‘ í˜¸ì¶œ
                            curl -X POST \\
                              -H "Authorization: token ${GITHUB_TOKEN}" \\
                              -H "Accept: application/vnd.github.v3+json" \\
                              https://api.github.com/repos/${GITHUB_REPO}/pulls \\
                              -d '{
                                "title": "ğŸš€ [Auto PR] Deploy develop to main - ${commitSha}",
                                "head": "develop",
                                "base": "main",
                                "body": ${groovy.json.JsonOutput.toJson(prBody)},
                                "labels": ["auto-pr", "deployment"]
                              }' || echo "PR creation failed or already exists"
                          fi
                        """
                    }
                }
            }
        }

        stage('Build & Push Image (main)') {
            when { branch 'main' }
            steps {
                withCredentials([credentials('dockerhub-credentials')]) {
                    dir('front') {
                        sh '''
                          echo "Building ${DOCKERHUB_CREDENTIALS_USR}/${IMAGE_NAME}:${IMAGE_TAG}"
                          docker build -t ${DOCKERHUB_CREDENTIALS_USR}/${IMAGE_NAME}:${IMAGE_TAG} -f Dockerfile .
                          echo "${DOCKERHUB_CREDENTIALS_PSW}" | docker login -u "${DOCKERHUB_CREDENTIALS_USR}" --password-stdin
                          docker push ${DOCKERHUB_CREDENTIALS_USR}/${IMAGE_NAME}:${IMAGE_TAG}
                        '''
                    }
                }
            }
        }

        stage('Deploy to Kubernetes (main)') {
            when { branch 'main' }
            steps {
                withCredentials([file(credentialsId: "${KUBECONFIG_CREDENTIALS}", variable: 'KUBECONFIG_FILE'), credentials('dockerhub-credentials')]) {
                    sh '''
                      export KUBECONFIG="${KUBECONFIG_FILE}"
                      ${KUBECTL_BIN} config use-context ${K8S_CONTEXT}
                      
                      # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±)
                      if ! ${KUBECTL_BIN} get ns ${K8S_NAMESPACE} >/dev/null 2>&1; then
                        echo "Creating namespace: ${K8S_NAMESPACE}"
                        ${KUBECTL_BIN} create ns ${K8S_NAMESPACE}
                      else
                        echo "Namespace ${K8S_NAMESPACE} already exists"
                      fi

                      # 1. Metrics Service ë°°í¬ (nginx-exporterë¥¼ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
                      ${KUBECTL_BIN} apply -f ${K8S_DIR}/service-metrics-nodeport.yam

                      # 2. Vue ì•± Deployment ë°°í¬ (ì´ë¯¸ì§€ íƒœê·¸ë¥¼ êµì²´í•œ í›„ ì ìš©)
                      ${KUBECTL_BIN} -n ${K8S_NAMESPACE} apply -f ${K8S_DIR}/deployment.yaml
                      ${KUBECTL_BIN} -n ${K8S_NAMESPACE} set image deployment/front front=${DOCKERHUB_CREDENTIALS_USR}/${IMAGE_NAME}:${IMAGE_TAG}
                      ${KUBECTL_BIN} -n ${K8S_NAMESPACE} rollout status deployment/front --timeout=180s

                      # ë©”íŠ¸ë¦­/í—¬ìŠ¤ ê°„ë‹¨ í™•ì¸
                      if [ -n "${K3S_NODE_IP}" ]; then
                        echo "[Info] Metrics endpoint: http://${K3S_NODE_IP}:9000/metrics"
                        echo "[Info] Test: curl http://${K3S_NODE_IP}:9000/metrics | head -n 5 || true"
                      else
                        echo "[Info] K3S_NODE_IP íŒŒë¼ë¯¸í„°ë¥¼ ì„¤ì •í•˜ë©´ metrics endpoint ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤."
                        echo "[Info] Metrics endpoint: http://<K3S_NODE_IP>:9000/metrics"
                      fi
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "OK: ${env.BRANCH_NAME} -> ${params.IMAGE_NAME}:${env.IMAGE_TAG}"
        }
        failure {
            echo "Pipeline failed."
        }
    }
}